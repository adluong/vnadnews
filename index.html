<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tin T·ª©c H√†n Qu·ªëc | Korean News Vietnamese</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1a1a2e;
      --secondary: #16213e;
      --accent: #e94560;
      --accent-soft: #ff6b6b;
      --text: #edf2f4;
      --text-muted: #8d99ae;
      --card-bg: rgba(26, 26, 46, 0.85);
      --border: rgba(233, 69, 96, 0.2);
      --header-bg: rgba(15, 15, 26, 0.95);
      --skeleton-shimmer: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
      --shadow-card: rgba(0, 0, 0, 0.3);
      --shadow-toast: rgba(0, 0, 0, 0.4);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --primary: #ffffff;
        --secondary: #f8f9fa;
        --accent: #e94560;
        --accent-soft: #ff6b6b;
        --text: #1a1a2e;
        --text-muted: #6c757d;
        --card-bg: rgba(255, 255, 255, 0.95);
        --border: rgba(233, 69, 96, 0.15);
        --header-bg: rgba(255, 255, 255, 0.95);
        --skeleton-shimmer: linear-gradient(90deg, rgba(0,0,0,0.05) 25%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.05) 75%);
        --shadow-card: rgba(0, 0, 0, 0.1);
        --shadow-toast: rgba(0, 0, 0, 0.15);
      }
    }

    body {
      min-height: 100vh;
      font-family: 'Be Vietnam Pro', 'Noto Sans KR', sans-serif;
      background: var(--body-bg, linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%));
      color: var(--text);
      position: relative;
      overflow-x: hidden;
    }

    @media (prefers-color-scheme: light) {
      body {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 50%, #f1f3f5 100%);
      }
      .bg-pattern {
        background-image:
          radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.06) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(233, 69, 96, 0.04) 0%, transparent 40%),
          url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e94560' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }
    }

    .bg-pattern {
      position: fixed;
      inset: 0;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(233, 69, 96, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(233, 69, 96, 0.05) 0%, transparent 40%),
        url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e94560' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--header-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      box-shadow: 0 4px 20px rgba(233, 69, 96, 0.3);
      font-family: 'Noto Sans KR', sans-serif;
    }

    .logo-text h1 {
      font-size: 1.4rem;
      font-weight: 700;
      background: linear-gradient(90deg, var(--text), var(--accent-soft));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-text p {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .refresh-btn {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--accent);
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-btn:hover {
      background: var(--accent);
      color: white;
      transform: scale(1.05);
    }

    .refresh-btn.spinning {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .auto-refresh-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    .auto-refresh-toggle input {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
    }

    /* Source Tabs */
    .source-tabs {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      position: relative;
      z-index: 1;
    }

    .source-tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.7rem 1.2rem;
      border-radius: 50px;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-family: inherit;
    }

    .tab:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    .tab.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      border-color: transparent;
      color: white;
      box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
    }

    .tab-icon {
      font-size: 1.1rem;
    }

    /* Status Bar */
    .status-bar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem 1rem;
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--text-muted);
      position: relative;
      z-index: 1;
    }

    .status-live {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* News Grid */
    .news-grid {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 1.2rem;
      position: relative;
      z-index: 1;
    }

    .news-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.5s ease forwards;
      opacity: 0;
      cursor: pointer;
      text-decoration: none;
      display: block;
    }

    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
      from { opacity: 0; transform: translateY(10px); }
    }

    .news-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-soft));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .news-card:hover {
      transform: translateY(-4px);
      border-color: rgba(233, 69, 96, 0.4);
      box-shadow: 0 10px 40px var(--shadow-card);
    }

    .news-card:hover::before {
      opacity: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.8rem;
    }

    .card-source {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.8rem;
      background: rgba(233, 69, 96, 0.15);
      color: var(--accent-soft);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-new-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      font-weight: 600;
    }

    .card-title-vi {
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.5;
      margin-bottom: 0.6rem;
      color: var(--text);
    }

    .card-title-ko {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: 'Noto Sans KR', sans-serif;
      line-height: 1.5;
      padding-left: 0.8rem;
      border-left: 2px solid var(--border);
    }

    .card-summary {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.6;
      margin-top: 0.8rem;
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .card-date {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .card-link {
      font-size: 0.8rem;
      color: var(--accent);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      transition: color 0.2s;
    }

    .card-link:hover {
      color: var(--accent-soft);
    }

    /* Skeleton Loading */
    .news-card.skeleton {
      pointer-events: none;
    }

    .skeleton-elem {
      background: var(--skeleton-shimmer);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    .skeleton-source {
      width: 100px;
      height: 24px;
      margin-bottom: 0.8rem;
    }

    .skeleton-title {
      height: 24px;
      margin-bottom: 0.5rem;
    }

    .skeleton-subtitle {
      height: 40px;
      margin-bottom: 1rem;
    }

    .skeleton-footer {
      height: 20px;
      width: 120px;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Empty State */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .empty-icon {
      font-size: 3rem;
      display: block;
      margin-bottom: 1rem;
    }

    /* Footer */
    .footer {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      text-align: center;
      border-top: 1px solid var(--border);
      position: relative;
      z-index: 1;
    }

    .footer p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 0.3rem;
    }

    .footer-note {
      font-size: 0.75rem !important;
      opacity: 0.6;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card-bg);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      box-shadow: 0 10px 40px var(--shadow-toast);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 1.3rem;
    }

    /* Translation Modal */
    .translate-status {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 0.8rem 1.5rem;
      display: none;
      align-items: center;
      gap: 0.8rem;
      font-size: 0.85rem;
      color: var(--text-muted);
      z-index: 1000;
    }

    .translate-status.show {
      display: flex;
    }

    .translate-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Load More Indicator */
    .load-more {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.8rem;
    }

    .load-more-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .load-more-text {
      font-size: 0.9rem;
    }

    .end-of-news {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .header-content {
        flex-direction: column;
        text-align: center;
      }

      .logo {
        flex-direction: column;
        gap: 0.5rem;
      }

      .logo-text {
        text-align: center;
      }

      .news-grid {
        grid-template-columns: 1fr;
      }

      .source-tabs {
        justify-content: flex-start;
      }

      .toast {
        left: 1rem;
        right: 1rem;
        bottom: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <span class="logo-icon">Ìïú</span>
        <div class="logo-text">
          <h1>Tin T·ª©c H√†n Qu·ªëc</h1>
          <p>Korean News ‚Ä¢ D·ªãch sang Ti·∫øng Vi·ªát</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="refresh-btn" id="refreshBtn" title="L√†m m·ªõi">‚Üª</button>
        <label class="auto-refresh-toggle">
          <input type="checkbox" id="autoRefresh" checked>
          <span>T·ª± ƒë·ªông c·∫≠p nh·∫≠t</span>
        </label>
      </div>
    </div>
  </header>

  <!-- Source Tabs -->
  <nav class="source-tabs" id="sourceTabs">
    <button class="tab active" data-source="all">
      <span class="tab-icon">üåê</span>
      <span>T·∫•t c·∫£</span>
    </button>
    <button class="tab" data-source="yonhap">
      <span class="tab-icon">üì∞</span>
      <span>Yonhap</span>
    </button>
    <button class="tab" data-source="kbs">
      <span class="tab-icon">üì∫</span>
      <span>KBS World</span>
    </button>
    <button class="tab" data-source="arirang">
      <span class="tab-icon">üåè</span>
      <span>Arirang</span>
    </button>
    <button class="tab" data-source="koreaherald">
      <span class="tab-icon">üìã</span>
      <span>Korea Herald</span>
    </button>
  </nav>

  <!-- Status Bar -->
  <div class="status-bar">
    <span class="status-live">
      <span class="live-dot"></span>
      C·∫≠p nh·∫≠t: <span id="lastUpdate">--:--:--</span>
    </span>
    <span id="newsCount">0 tin t·ª©c</span>
  </div>

  <!-- News Grid -->
  <main class="news-grid" id="newsGrid">
    <!-- News cards will be inserted here -->
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>üá∞üá∑ ‚Üí üáªüá≥ D·ªãch t·ª± ƒë·ªông b·∫±ng AI</p>
    <p class="footer-note">Ngu·ªìn: Yonhap, KBS World, Arirang, Korea Herald</p>
  </footer>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span class="toast-icon">‚ú®</span>
    <span id="toastMessage">Tin m·ªõi!</span>
  </div>

  <!-- Translation Status -->
  <div class="translate-status" id="translateStatus">
    <div class="translate-spinner"></div>
    <span>ƒêang d·ªãch tin t·ª©c...</span>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    
    const CONFIG = {
      // CORS proxy for RSS feeds (you may need to use your own or deploy one)
      corsProxy: 'https://api.allorigins.win/raw?url=',
      
      // News sources with their RSS feeds
      sources: {
        yonhap: {
          name: 'Yonhap News',
          icon: 'üì∞',
          rss: 'https://en.yna.co.kr/RSS/news.xml'
        },
        kbs: {
          name: 'KBS World',
          icon: 'üì∫',
          rss: 'https://world.kbs.co.kr/rss/rss_news.htm?lang=e'
        },
        arirang: {
          name: 'Arirang',
          icon: 'üåè',
          rss: 'https://www.arirang.com/rss/news_all.xml'
        },
        koreaherald: {
          name: 'Korea Herald',
          icon: 'üìã',
          rss: 'https://www.koreaherald.com/rss_xml.php'
        }
      },
      
      // Refresh interval in milliseconds (10 minutes)
      refreshInterval: 600000,

      // Max news items per source (for RSS fetch)
      maxItemsPerSource: 20,

      // Items to display per page (for infinite scroll)
      itemsPerPage: 6
    };

    // ============================================
    // STATE
    // ============================================
    
    let state = {
      activeSource: 'all',
      news: [],
      displayedCount: 0,
      loading: false,
      loadingMore: false,
      autoRefresh: true,
      refreshTimer: null,
      translationCache: new Map()
    };

    // ============================================
    // DOM ELEMENTS
    // ============================================
    
    const elements = {
      newsGrid: document.getElementById('newsGrid'),
      refreshBtn: document.getElementById('refreshBtn'),
      autoRefreshCheck: document.getElementById('autoRefresh'),
      lastUpdate: document.getElementById('lastUpdate'),
      newsCount: document.getElementById('newsCount'),
      toast: document.getElementById('toast'),
      toastMessage: document.getElementById('toastMessage'),
      translateStatus: document.getElementById('translateStatus'),
      sourceTabs: document.getElementById('sourceTabs')
    };

    // ============================================
    // TRANSLATION (Using LibreTranslate or Google Translate)
    // ============================================
    
    // Simple translation using MyMemory API (free, no API key needed)
    async function translateToVietnamese(text) {
      if (!text || text.trim() === '') return text;

      // Check cache first
      if (state.translationCache.has(text)) {
        return state.translationCache.get(text);
      }

      try {
        // Truncate long text to avoid API limits (500 chars max for MyMemory)
        const truncatedText = text.length > 450 ? text.substring(0, 450) + '...' : text;

        const response = await fetch(
          `https://api.mymemory.translated.net/get?q=${encodeURIComponent(truncatedText)}&langpair=en|vi`
        );

        if (!response.ok) {
          console.error('Translation API error:', response.status);
          return text;
        }

        const data = await response.json();

        if (data.responseStatus === 200 && data.responseData?.translatedText) {
          let translated = data.responseData.translatedText;
          // MyMemory sometimes returns uppercase warning - filter it out
          if (translated.includes('MYMEMORY WARNING')) {
            translated = text;
          }
          state.translationCache.set(text, translated);
          return translated;
        }
        return text;
      } catch (error) {
        console.error('Translation error:', error);
        return text;
      }
    }

    // Translate a batch of news items (parallel for speed, with rate limiting)
    async function translateNewsItems(items) {
      // Process items in smaller batches to avoid rate limiting
      const batchSize = 3;

      for (let i = 0; i < items.length; i += batchSize) {
        const batch = items.slice(i, i + batchSize);
        const translationPromises = batch.map(async (item) => {
          // Mark as translating
          item.isTranslating = true;

          // Translate title if not already translated
          if (!item.titleVi || item.titleVi === item.titleOriginal) {
            item.titleVi = await translateToVietnamese(item.titleOriginal);
          }

          // Translate description if exists and not already translated
          if (item.description && (!item.descriptionVi || item.descriptionVi === item.description)) {
            const cleanDesc = item.description.replace(/<[^>]*>/g, '').trim();
            if (cleanDesc) {
              item.descriptionVi = await translateToVietnamese(cleanDesc);
            }
          }

          item.isTranslating = false;
          item.isTranslated = true;
        });

        await Promise.all(translationPromises);

        // Small delay between batches to avoid rate limiting
        if (i + batchSize < items.length) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
    }

    // ============================================
    // RSS PARSING
    // ============================================

    // List of CORS proxies to try (fallback chain)
    const CORS_PROXIES = [
      'https://api.allorigins.win/raw?url=',
      'https://corsproxy.io/?',
      'https://api.codetabs.com/v1/proxy?quest='
    ];

    async function fetchRSS(url) {
      let lastError = null;

      // Try each proxy in order
      for (const proxy of CORS_PROXIES) {
        try {
          const proxyUrl = proxy + encodeURIComponent(url);
          const response = await fetch(proxyUrl, {
            signal: AbortSignal.timeout(10000) // 10 second timeout
          });

          if (!response.ok) {
            console.warn(`Proxy ${proxy} returned status ${response.status}`);
            continue;
          }

          const text = await response.text();

          // Check if we got valid XML
          if (!text || text.trim() === '' || text.includes('<!DOCTYPE html>')) {
            console.warn(`Proxy ${proxy} returned invalid content for ${url}`);
            continue;
          }

          const parser = new DOMParser();
          const xml = parser.parseFromString(text, 'text/xml');

          // Check for XML parsing errors
          const parseError = xml.querySelector('parsererror');
          if (parseError) {
            console.warn(`XML parse error from ${proxy}: ${parseError.textContent}`);
            continue;
          }

          // Check if we have items
          const items = xml.querySelectorAll('item');
          if (items.length > 0) {
            return xml;
          }

          console.warn(`No items found in RSS from ${proxy} for ${url}`);
        } catch (error) {
          lastError = error;
          console.warn(`Proxy ${proxy} failed:`, error.message);
        }
      }

      console.error('All CORS proxies failed for:', url, lastError);
      return null;
    }

    function parseRSSItems(xml, sourceName) {
      if (!xml) return [];
      
      const items = xml.querySelectorAll('item');
      const newsItems = [];
      
      items.forEach((item, index) => {
        if (index >= CONFIG.maxItemsPerSource) return;
        
        const title = item.querySelector('title')?.textContent || '';
        const link = item.querySelector('link')?.textContent || '';
        const pubDate = item.querySelector('pubDate')?.textContent || '';
        const description = item.querySelector('description')?.textContent || '';
        
        newsItems.push({
          id: `${sourceName}-${index}-${Date.now()}`,
          source: sourceName,
          titleOriginal: title,
          titleVi: title, // Will be translated
          description: description,
          descriptionVi: description, // Will be translated
          link: link,
          pubDate: new Date(pubDate),
          isNew: false
        });
      });
      
      return newsItems;
    }

    // ============================================
    // NEWS FETCHING
    // ============================================
    
    async function fetchAllNews() {
      if (state.loading) return;

      state.loading = true;
      elements.refreshBtn.classList.add('spinning');
      showTranslateStatus(true);

      const allNews = [];
      // Always fetch from ALL sources regardless of active tab
      const sourcesToFetch = Object.keys(CONFIG.sources);

      console.log('Fetching news from sources:', sourcesToFetch);

      // Fetch from all sources in parallel
      const fetchPromises = sourcesToFetch.map(async (sourceKey) => {
        const source = CONFIG.sources[sourceKey];
        if (!source) return [];

        try {
          console.log(`Fetching from ${sourceKey}: ${source.rss}`);
          const xml = await fetchRSS(source.rss);
          const items = parseRSSItems(xml, sourceKey);
          console.log(`Got ${items.length} items from ${sourceKey}`);
          return items;
        } catch (error) {
          console.error(`Error fetching ${sourceKey}:`, error);
          return [];
        }
      });

      const results = await Promise.allSettled(fetchPromises);
      results.forEach((result, index) => {
        if (result.status === 'fulfilled' && result.value.length > 0) {
          allNews.push(...result.value);
        } else if (result.status === 'rejected') {
          console.error(`Failed to fetch ${sourcesToFetch[index]}:`, result.reason);
        }
      });

      console.log(`Total news fetched: ${allNews.length}`);

      // Sort by date (newest first)
      allNews.sort((a, b) => b.pubDate - a.pubDate);

      // Check for new items
      const existingIds = new Set(state.news.map(n => n.titleOriginal));
      allNews.forEach(item => {
        if (!existingIds.has(item.titleOriginal)) {
          item.isNew = state.news.length > 0;
        }
      });

      state.news = allNews;
      state.loading = false;

      elements.refreshBtn.classList.remove('spinning');
      showTranslateStatus(false);
      updateLastUpdate();
      await renderNews();

      // Show toast if new items
      const newItems = allNews.filter(n => n.isNew);
      if (newItems.length > 0) {
        showToast(`${newItems.length} tin m·ªõi!`);
      }
    }

    // ============================================
    // SAMPLE DATA (Fallback when RSS fails)
    // ============================================
    
    function getSampleNews() {
      return [
        {
          id: '1',
          source: 'yonhap',
          titleOriginal: 'South Korea sees economic growth forecast raised',
          titleVi: 'H√†n Qu·ªëc n√¢ng d·ª± b√°o tƒÉng tr∆∞·ªüng kinh t·∫ø',
          descriptionVi: 'C√°c chuy√™n gia kinh t·∫ø ƒë√£ n√¢ng d·ª± b√°o tƒÉng tr∆∞·ªüng GDP c·ªßa H√†n Qu·ªëc trong nƒÉm nay l√™n m·ª©c cao h∆°n, nh·ªù v√†o s·ª± ph·ª•c h·ªìi m·∫°nh m·∫Ω c·ªßa ng√†nh xu·∫•t kh·∫©u v√† ti√™u d√πng n·ªôi ƒë·ªãa. Ch√≠nh ph·ªß c≈©ng ƒë√£ c√¥ng b·ªë c√°c bi·ªán ph√°p h·ªó tr·ª£ doanh nghi·ªáp nh·ªè v√† v·ª´a.',
          link: '#',
          pubDate: new Date(),
          isNew: false
        },
        {
          id: '2',
          source: 'kbs',
          titleOriginal: 'Winter cold wave warning issued across the country',
          titleVi: 'C·∫£nh b√°o gi√° r√©t m√πa ƒë√¥ng ƒë∆∞·ª£c ban h√†nh tr√™n to√†n qu·ªëc',
          descriptionVi: 'C∆° quan kh√≠ t∆∞·ª£ng H√†n Qu·ªëc ƒë√£ ban h√†nh c·∫£nh b√°o v·ªÅ ƒë·ª£t kh√¥ng kh√≠ l·∫°nh s·∫Øp tr√†n xu·ªëng, v·ªõi nhi·ªát ƒë·ªô d·ª± ki·∫øn gi·∫£m xu·ªëng d∆∞·ªõi √¢m 15 ƒë·ªô C t·∫°i c√°c v√πng n√∫i ph√≠a b·∫Øc. Ng∆∞·ªùi d√¢n ƒë∆∞·ª£c khuy·∫øn c√°o h·∫°n ch·∫ø ra ngo√†i v√†o ban ƒë√™m.',
          link: '#',
          pubDate: new Date(Date.now() - 3600000),
          isNew: false
        },
        {
          id: '3',
          source: 'arirang',
          titleOriginal: 'K-pop group achieves record-breaking album sales',
          titleVi: 'Nh√≥m K-pop ƒë·∫°t doanh s·ªë album k·ª∑ l·ª•c',
          descriptionVi: 'Album m·ªõi nh·∫•t c·ªßa nh√≥m nh·∫°c K-pop n·ªïi ti·∫øng ƒë√£ ph√° v·ª° k·ª∑ l·ª•c doanh s·ªë trong tu·∫ßn ƒë·∫ßu ti√™n ph√°t h√†nh, v·ªõi h∆°n 2 tri·ªáu b·∫£n ƒë∆∞·ª£c b√°n ra tr√™n to√†n c·∫ßu. ƒê√¢y l√† th√†nh t√≠ch cao nh·∫•t trong l·ªãch s·ª≠ √¢m nh·∫°c H√†n Qu·ªëc.',
          link: '#',
          pubDate: new Date(Date.now() - 7200000),
          isNew: false
        },
        {
          id: '4',
          source: 'koreaherald',
          titleOriginal: 'Korea-Vietnam economic cooperation strengthened',
          titleVi: 'H·ª£p t√°c kinh t·∫ø H√†n Qu·ªëc-Vi·ªát Nam ƒë∆∞·ª£c tƒÉng c∆∞·ªùng',
          descriptionVi: 'Hai n∆∞·ªõc ƒë√£ k√Ω k·∫øt nhi·ªÅu th·ªèa thu·∫≠n h·ª£p t√°c m·ªõi trong c√°c lƒ©nh v·ª±c c√¥ng ngh·ªá, nƒÉng l∆∞·ª£ng t√°i t·∫°o v√† gi√°o d·ª•c. Kim ng·∫°ch th∆∞∆°ng m·∫°i song ph∆∞∆°ng d·ª± ki·∫øn s·∫Ω ƒë·∫°t 100 t·ª∑ USD trong nƒÉm t·ªõi, tƒÉng 15% so v·ªõi nƒÉm tr∆∞·ªõc.',
          link: '#',
          pubDate: new Date(Date.now() - 10800000),
          isNew: false
        },
        {
          id: '5',
          source: 'yonhap',
          titleOriginal: 'Seoul announces new cultural festival plans',
          titleVi: 'Seoul c√¥ng b·ªë k·∫ø ho·∫°ch l·ªÖ h·ªôi vƒÉn h√≥a m·ªõi',
          descriptionVi: 'Th√†nh ph·ªë Seoul s·∫Ω t·ªï ch·ª©c l·ªÖ h·ªôi vƒÉn h√≥a qu·ªëc t·∫ø k√©o d√†i m·ªôt th√°ng v√†o m√πa xu√¢n nƒÉm sau, v·ªõi s·ª± tham gia c·ªßa h∆°n 50 qu·ªëc gia. S·ª± ki·ªán s·∫Ω bao g·ªìm c√°c bu·ªïi bi·ªÉu di·ªÖn ngh·ªá thu·∫≠t, tri·ªÉn l√£m v√† ·∫©m th·ª±c ƒë∆∞·ªùng ph·ªë.',
          link: '#',
          pubDate: new Date(Date.now() - 14400000),
          isNew: false
        },
        {
          id: '6',
          source: 'kbs',
          titleOriginal: 'National football team prepares for Asian Cup',
          titleVi: 'ƒê·ªôi tuy·ªÉn b√≥ng ƒë√° qu·ªëc gia chu·∫©n b·ªã cho Asian Cup',
          descriptionVi: 'ƒê·ªôi tuy·ªÉn b√≥ng ƒë√° qu·ªëc gia H√†n Qu·ªëc ƒëang t·∫≠p trung chu·∫©n b·ªã cho gi·∫£i v√¥ ƒë·ªãch Asian Cup s·∫Øp t·ªõi. Hu·∫•n luy·ªán vi√™n tr∆∞·ªüng ƒë√£ tri·ªáu t·∫≠p 26 c·∫ßu th·ªß, bao g·ªìm nhi·ªÅu ng√¥i sao ƒëang thi ƒë·∫•u t·∫°i ch√¢u √Çu.',
          link: '#',
          pubDate: new Date(Date.now() - 18000000),
          isNew: false
        }
      ];
    }

    // ============================================
    // RENDERING
    // ============================================
    
    function renderSkeleton() {
      elements.newsGrid.innerHTML = Array(6).fill(0).map(() => `
        <div class="news-card skeleton">
          <div class="skeleton-elem skeleton-source"></div>
          <div class="skeleton-elem skeleton-title"></div>
          <div class="skeleton-elem skeleton-subtitle"></div>
          <div class="skeleton-elem skeleton-footer"></div>
        </div>
      `).join('');
    }

    function getFilteredNews() {
      return state.activeSource === 'all'
        ? state.news
        : state.news.filter(n => n.source === state.activeSource);
    }

    function renderNewsCard(item, index) {
      const source = CONFIG.sources[item.source];
      const timeAgo = getTimeAgo(item.pubDate);

      // Show Vietnamese title, or original if translation failed/pending
      const displayTitle = item.titleVi && item.titleVi !== item.titleOriginal
        ? item.titleVi
        : item.titleOriginal;

      // Show translated description if available
      const displayDesc = item.descriptionVi && item.descriptionVi !== item.description
        ? item.descriptionVi
        : (item.description ? item.description.replace(/<[^>]*>/g, '').trim() : '');

      return `
        <a href="${item.link}" target="_blank" rel="noopener"
           class="news-card" style="animation-delay: ${index * 0.05}s">
          <div class="card-header">
            <span class="card-source">
              ${source?.icon || 'üì∞'} ${source?.name || item.source}
            </span>
            ${item.isNew ? '<span class="card-new-badge">M·ªöI</span>' : ''}
          </div>
          <h3 class="card-title-vi">${displayTitle}</h3>
          <p class="card-title-ko">${item.titleOriginal}</p>
          ${displayDesc ? `<p class="card-summary">${displayDesc}</p>` : ''}
          <div class="card-footer">
            <span class="card-date">${timeAgo}</span>
            <span class="card-link">ƒê·ªçc th√™m ‚Üí</span>
          </div>
        </a>
      `;
    }

    async function renderNews(reset = true) {
      const allNews = getFilteredNews();

      elements.newsCount.textContent = `${allNews.length} tin t·ª©c`;

      if (allNews.length === 0) {
        elements.newsGrid.innerHTML = `
          <div class="empty-state">
            <span class="empty-icon">üì≠</span>
            <p>Kh√¥ng c√≥ tin t·ª©c. Nh·∫•n n√∫t l√†m m·ªõi ƒë·ªÉ t·∫£i tin.</p>
          </div>
        `;
        state.displayedCount = 0;
        return;
      }

      if (reset) {
        state.displayedCount = 0;
        elements.newsGrid.innerHTML = '';
      }

      const startIndex = state.displayedCount;
      const endIndex = Math.min(startIndex + CONFIG.itemsPerPage, allNews.length);
      const newsToRender = allNews.slice(startIndex, endIndex);

      // Lazy translation: only translate items being displayed
      showTranslateStatus(true);
      await translateNewsItems(newsToRender);
      showTranslateStatus(false);

      const html = newsToRender.map((item, i) => renderNewsCard(item, startIndex + i)).join('');
      elements.newsGrid.insertAdjacentHTML('beforeend', html);

      state.displayedCount = endIndex;

      // Add end indicator or loading placeholder
      const existingIndicator = elements.newsGrid.querySelector('.load-more, .end-of-news');
      if (existingIndicator) existingIndicator.remove();

      if (state.displayedCount >= allNews.length) {
        elements.newsGrid.insertAdjacentHTML('beforeend', `
          <div class="end-of-news">ƒê√£ hi·ªÉn th·ªã t·∫•t c·∫£ tin t·ª©c</div>
        `);
      }
    }

    async function loadMoreNews() {
      const allNews = getFilteredNews();
      if (state.loadingMore || state.displayedCount >= allNews.length) return;

      state.loadingMore = true;

      // Add loading indicator
      const existingIndicator = elements.newsGrid.querySelector('.end-of-news');
      if (existingIndicator) existingIndicator.remove();

      elements.newsGrid.insertAdjacentHTML('beforeend', `
        <div class="load-more">
          <div class="load-more-spinner"></div>
          <span class="load-more-text">ƒêang d·ªãch tin t·ª©c...</span>
        </div>
      `);

      // Translate and render next batch
      await renderNews(false);

      const loadingEl = elements.newsGrid.querySelector('.load-more');
      if (loadingEl) loadingEl.remove();

      state.loadingMore = false;
    }

    // Debounced scroll handler
    let scrollTimeout = null;
    function handleScroll() {
      if (scrollTimeout) return;

      scrollTimeout = setTimeout(() => {
        scrollTimeout = null;

        const scrollY = window.scrollY;
        const windowHeight = window.innerHeight;
        const docHeight = document.documentElement.scrollHeight;

        // Load more when 300px from bottom
        if (scrollY + windowHeight >= docHeight - 300) {
          loadMoreNews();
        }
      }, 100);
    }

    // ============================================
    // UTILITIES
    // ============================================
    
    function getTimeAgo(date) {
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days} ng√†y tr∆∞·ªõc`;
      if (hours > 0) return `${hours} gi·ªù tr∆∞·ªõc`;
      if (minutes > 0) return `${minutes} ph√∫t tr∆∞·ªõc`;
      return 'V·ª´a xong';
    }

    function updateLastUpdate() {
      const now = new Date();
      elements.lastUpdate.textContent = now.toLocaleTimeString('vi-VN');
    }

    function showToast(message) {
      elements.toastMessage.textContent = message;
      elements.toast.classList.add('show');
      setTimeout(() => elements.toast.classList.remove('show'), 3000);
    }

    function showTranslateStatus(show) {
      elements.translateStatus.classList.toggle('show', show);
    }

    function startAutoRefresh() {
      if (state.refreshTimer) clearInterval(state.refreshTimer);
      if (state.autoRefresh) {
        state.refreshTimer = setInterval(fetchAllNews, CONFIG.refreshInterval);
      }
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================
    
    elements.refreshBtn.addEventListener('click', fetchAllNews);

    elements.autoRefreshCheck.addEventListener('change', (e) => {
      state.autoRefresh = e.target.checked;
      startAutoRefresh();
    });

    elements.sourceTabs.addEventListener('click', async (e) => {
      const tab = e.target.closest('.tab');
      if (!tab) return;

      // Update active tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      // Update state and re-render (reset to first page)
      state.activeSource = tab.dataset.source;
      await renderNews(true);
    });

    // Infinite scroll listener
    window.addEventListener('scroll', handleScroll);

    // ============================================
    // INITIALIZATION
    // ============================================
    
    async function init() {
      renderSkeleton();
      
      // Try to fetch real RSS feeds
      await fetchAllNews();
      
      // If no news loaded, use sample data
      if (state.news.length === 0) {
        state.news = getSampleNews();
        await renderNews();
        showToast('ƒêang d√πng d·ªØ li·ªáu m·∫´u');
      }
      
      startAutoRefresh();
    }

    // Start the app
    init();
  </script>
</body>
</html>
